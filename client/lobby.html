<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineGuess - Lobby</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="background-ambient"></div>

    <main class="menu-container">
        <header class="menu-header">
            <h1 id="status-header"></h1>
        </header>

        <div id="lobby-panel" class="glass-panel menu-panel">

            <!-- STEP 1: Identification -->
            <div id="identity-section" class="menu-section">
                <label class="menu-label">YOUR NAME</label>
                <input type="text" id="username-input" class="text-input" placeholder="Enter Username">
            </div>

            <!-- STEP 2: Choose Mode -->
            <div id="lobby-menu" class="menu-actions">
                <button id="lobby-host-btn" class="btn-primary full-width">HOST GAME</button>
                <button id="lobby-join-btn" class="btn-secondary full-width">JOIN GAME</button>
                <button id="back-home-btn" class="btn-secondary full-width"
                    style="margin-top: 1rem; border-color: transparent;">BACK TO MENU</button>
            </div>

            <!-- HOST VIEW -->
            <div id="room-code-section" class="menu-section hidden">
                <label class="menu-label">ROOM CODE</label>
                <div class="room-code-display">
                    <span id="room-code-value">----</span>
                    <button id="copy-code-btn" class="btn-icon-small" title="Copy Code">ðŸ“‹</button>
                </div>
                <p class="instruction-text">Share this code with friends!</p>
            </div>

            <!-- JOIN VIEW -->
            <div id="join-code-section" class="menu-section hidden">
                <label class="menu-label">ENTER ROOM CODE</label>
                <input type="text" id="room-code-input" class="text-input" placeholder="e.g. ABCD" maxlength="4">
            </div>

            <!-- WAITING AREA (Common) -->
            <div id="player-section" class="menu-section hidden">
                <label class="menu-label">PLAYERS IN LOBBY</label>
                <ul id="player-list" class="player-list">
                    <li class="player-item"><span class="player-avatar">ðŸ‘¤</span> <span class="player-name">You</span>
                    </li>
                </ul>
            </div>

            <div class="menu-actions">
                <button id="start-game-btn" class="btn-primary full-width hidden">START GAME</button>
                <button id="join-action-btn" class="btn-primary full-width hidden">JOIN</button>
                <button id="leave-lobby-btn" class="btn-secondary full-width hidden">LEAVE LOBBY</button>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, off } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-functions.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC-t05JZI_A35C73OUh4Hj-3DgpLQbE2m8",
            authDomain: "cineguess-db.firebaseapp.com",
            projectId: "cineguess-db",
            storageBucket: "cineguess-db.firebasestorage.app",
            messagingSenderId: "312520735771",
            appId: "1:312520735771:web:62ff4b138c5da008dc8cbe",
            measurementId: "G-QW14ZVKXM0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const functions = getFunctions(app);

        // State
        let currentRoomCode = null;
        let currentPlayerId = null;
        let isHost = false;
        let roomListener = null;

        // DOM Elements
        const lobbyMenu = document.getElementById('lobby-menu');
        const lobbyHostBtn = document.getElementById('lobby-host-btn');
        const lobbyJoinBtn = document.getElementById('lobby-join-btn');
        const backHomeBtn = document.getElementById('back-home-btn');
        const roomCodeSection = document.getElementById('room-code-section');
        const joinCodeSection = document.getElementById('join-code-section');
        const playerSection = document.getElementById('player-section');
        const startGameBtn = document.getElementById('start-game-btn');
        const joinActionBtn = document.getElementById('join-action-btn');
        const leaveLobbyBtn = document.getElementById('leave-lobby-btn');
        const roomCodeValue = document.getElementById('room-code-value');
        const usernameInput = document.getElementById('username-input');
        const roomCodeInput = document.getElementById('room-code-input');
        const playerList = document.getElementById('player-list');
        const statusHeader = document.getElementById('status-header');
        const copyCodeBtn = document.getElementById('copy-code-btn');

        // Game Config
        const urlParams = new URLSearchParams(window.location.search);
        const gameConfig = {
            genre: urlParams.get('genre') || 'All',
            minYear: parseInt(urlParams.get('minYear')) || 1990,
            maxYear: parseInt(urlParams.get('maxYear')) || 2030,
            minRating: parseFloat(urlParams.get('minRating')) || 0
        };

        // --- Functions ---

        async function createRoom() {
            setLoading(true);
            const createRoomFn = httpsCallable(functions, 'createRoom');
            try {
                const result = await createRoomFn({
                    username: usernameInput.value.trim(),
                    config: gameConfig
                });
                
                currentRoomCode = result.data.roomCode;
                currentPlayerId = result.data.playerId;
                isHost = true;
                
                setupWaitingRoom();
            } catch (error) {
                console.error(error);
                alert("Failed to create room: " + error.message);
                setLoading(false);
            }
        }

        async function joinRoom() {
            if(joinActionBtn.disabled) return;
            const code = roomCodeInput.value.trim().toUpperCase();
            if(!code) return;

            setLoading(true);
            const joinRoomFn = httpsCallable(functions, 'joinRoom');
            try {
                const result = await joinRoomFn({
                    username: usernameInput.value.trim(),
                    roomCode: code
                });

                currentRoomCode = code;
                currentPlayerId = result.data.playerId;
                isHost = false;

                setupWaitingRoom();
            } catch (error) {
                console.error(error);
                alert("Failed to join room: " + error.message);
                setLoading(false);
            }
        }

        async function startGame() {
            if(!isHost || !currentRoomCode) return;
            const startGameFn = httpsCallable(functions, 'startGame');
            try {
                await startGameFn({ 
                    roomCode: currentRoomCode,
                    playerId: currentPlayerId
                });
            } catch (error) {
                console.error(error);
                alert("Failed to start game: " + error.message);
            }
        }

        function setupWaitingRoom() {
            // UI Switching
            lobbyMenu.classList.add('hidden');
            joinCodeSection.classList.add('hidden');
            
            if(isHost) {
                roomCodeSection.classList.remove('hidden');
                roomCodeValue.innerText = currentRoomCode;
                startGameBtn.classList.remove('hidden');
            } else {
                roomCodeSection.classList.add('hidden');
                startGameBtn.classList.add('hidden');
            }

            playerSection.classList.remove('hidden');
            leaveLobbyBtn.classList.remove('hidden');
            statusHeader.innerText = "WAITING FOR PLAYERS...";
            setLoading(false);

            // RTDB Listener
            const roomRef = ref(db, `rooms/${currentRoomCode}`);
            roomListener = onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                if(!data) {
                    alert("Room was deleted.");
                    resetLobby();
                    return;
                }

                updatePlayerList(data.players);

                if(data.status === 'playing') {
                    // Navigate to Game
                    window.location.href = `game.html?room=${currentRoomCode}&player=${currentPlayerId}`;
                }
            });
        }

        function updatePlayerList(players) {
            playerList.innerHTML = '';
            const list = Object.values(players || {});
            list.forEach(p => {
                const li = document.createElement('li');
                li.className = 'player-item';
                li.innerHTML = `<span class="player-avatar">${p.isHost ? 'ðŸ‘‘' : 'ðŸ‘¤'}</span> <span class="player-name">${p.username}</span>`;
                playerList.appendChild(li);
            });
        }

        function resetLobby() {
            // Cleanup
            if(roomListener) {
                const roomRef = ref(db, `rooms/${currentRoomCode}`);
                off(roomRef);
                roomListener = null;
            }
            currentRoomCode = null;
            currentPlayerId = null;
            isHost = false;

            // UI Reset
            lobbyMenu.classList.remove('hidden');
            roomCodeSection.classList.add('hidden');
            joinCodeSection.classList.add('hidden');
            playerSection.classList.add('hidden');
            startGameBtn.classList.add('hidden');
            joinActionBtn.classList.add('hidden');
            leaveLobbyBtn.classList.add('hidden');
            statusHeader.innerText = "";
            usernameInput.disabled = false;
        }

        function setLoading(isLoading) {
            // Simple loading state helpers
            if(isLoading) {
                document.body.style.cursor = 'wait';
                lobbyHostBtn.disabled = true;
                lobbyJoinBtn.disabled = true;
                joinActionBtn.disabled = true;
            } else {
                document.body.style.cursor = 'default';
                lobbyHostBtn.disabled = false;
                lobbyJoinBtn.disabled = false;
                joinActionBtn.disabled = false;
            }
        }

        // --- Event Listeners ---

        lobbyHostBtn.addEventListener('click', () => {
            if (!usernameInput.value) { usernameInput.focus(); return; }
            createRoom();
        });

        lobbyJoinBtn.addEventListener('click', () => {
            if (!usernameInput.value) { usernameInput.focus(); return; }
            lobbyMenu.classList.add('hidden');
            joinCodeSection.classList.remove('hidden');
            joinActionBtn.classList.remove('hidden');
            leaveLobbyBtn.classList.remove('hidden');
        });

        joinActionBtn.addEventListener('click', joinRoom);

        startGameBtn.addEventListener('click', startGame);

        leaveLobbyBtn.addEventListener('click', resetLobby);

        backHomeBtn.addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        copyCodeBtn.addEventListener('click', async () => {
             const code = roomCodeValue.innerText;
             try {
                 if (navigator.clipboard && navigator.clipboard.writeText) {
                     await navigator.clipboard.writeText(code);
                     alert("Room code copied!");
                 } else {
                     throw new Error('Clipboard API unavailable');
                 }
             } catch (err) {
                 // Fallback
                 const textArea = document.createElement("textarea");
                 textArea.value = code;
                 textArea.style.position = "fixed";
                 document.body.appendChild(textArea);
                 textArea.focus();
                 textArea.select();
                 try {
                     document.execCommand('copy');
                     alert("Room code copied!");
                 } catch (e) {
                     alert("Failed to copy code.");
                 }
                 document.body.removeChild(textArea);
             }
        });

    </script>
</body>

</html>